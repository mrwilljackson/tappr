# UUID Changes in the TAPPR API

## Overview

The TAPPR API now uses two UUID fields for brews (beers):

1. `api_brew_uuid`: A UUID generated by the API that serves as the unique immutable key for the record in the database.
2. `brew_uuid`: A UUID provided by the companion app that serves as a reference for the app.

This document explains the changes and how to use the new UUID fields.

## Database Schema Changes

### Brews Table

The `beers` table has been renamed to `brews` and now includes both UUID fields:

| Column Name | Data Type | Description | Constraints |
|-------------|-----------|-------------|-------------|
| id | integer | Unique identifier for the brew | Primary Key, Auto-increment |
| api_brew_uuid | text | UUID generated by the API | Not Null, Unique |
| brew_uuid | text | UUID provided by the companion app | Not Null |
| ... | ... | ... | ... |

### Reviews Table

The `reviews` table now references the `api_brew_uuid` field in the `brews` table:

| Column Name | Data Type | Description | Constraints |
|-------------|-----------|-------------|-------------|
| id | integer | Unique identifier for the review | Primary Key, Auto-increment |
| review_id | text | UUID for the review | Not Null, Unique |
| api_brew_uuid | text | UUID of the brew being reviewed | Not Null, Foreign Key to brews.api_brew_uuid |
| brew_uuid | text | UUID of the brew in the companion app | Nullable |
| ... | ... | ... | ... |

## API Changes

### Creating a New Brew

When creating a new brew, you can provide a `brewUuid` from the companion app. The API will generate a new `api_brew_uuid` for the brew and return both UUIDs in the response.

**Request:**
```json
{
  "name": "New Brew",
  "style": "IPA",
  "abv": 5.5,
  "ibu": 40.5,
  "description": "Description of the brew",
  "brewDate": "2024-04-01",
  "kegLevel": 100,
  "brewUuid": "550e8400-e29b-41d4-a716-446655440001"
}
```

**Response:**
```json
{
  "message": "Brew added successfully",
  "brew": {
    "id": 4,
    "name": "New Brew",
    "style": "IPA",
    "abv": 5.5,
    "ibu": 40.5,
    "description": "Description of the brew",
    "brewDate": "2024-04-01",
    "kegLevel": 100,
    "brewUuid": "550e8400-e29b-41d4-a716-446655440001",
    "apiBrewUuid": "7dfb14c4-d288-4b1e-ae69-ec2d733aa434",
    "createdAt": "2024-04-15T14:30:00Z",
    "updatedAt": "2024-04-15T14:30:00Z"
  }
}
```

### Fetching a Brew

You can fetch a brew using either the `api_brew_uuid` or the `brew_uuid`:

- By API UUID: `GET /api/beers/api/{apiBrewUuid}`
- By Companion App UUID: `GET /api/beers/public/{brewUuid}`

Both endpoints will return the brew with both UUIDs.

### Creating a Review

When creating a review, you must provide the `apiBrewUuid` of the brew being reviewed:

**Request:**
```json
{
  "apiBrewUuid": "7dfb14c4-d288-4b1e-ae69-ec2d733aa434",
  "brewUuid": "550e8400-e29b-41d4-a716-446655440001",
  "reviewerName": "John Doe",
  "reviewType": "quick",
  "quickReview": {
    "overallRating": 4,
    "comments": "Great brew!"
  }
}
```

**Response:**
```json
{
  "message": "Review added successfully",
  "review": {
    "id": 1,
    "reviewId": "9d7f25e7-7b3c-4d1a-b6e8-f8a9b5c7d6e5",
    "apiBrewUuid": "7dfb14c4-d288-4b1e-ae69-ec2d733aa434",
    "brewUuid": "550e8400-e29b-41d4-a716-446655440001",
    "reviewerName": "John Doe",
    "isAnonymous": false,
    "reviewDate": "2024-04-15T14:30:00Z",
    "reviewType": "quick",
    "quickReview": {
      "overallRating": 4,
      "comments": "Great brew!"
    },
    "createdAt": "2024-04-15T14:30:00Z",
    "updatedAt": "2024-04-15T14:30:00Z"
  }
}
```

### Public Review Submission

For public review submissions, you can provide just the `brewUuid` and the API will look up the corresponding `apiBrewUuid`:

**Request:**
```json
{
  "brewUuid": "550e8400-e29b-41d4-a716-446655440001",
  "reviewerName": "Public Reviewer",
  "reviewType": "quick",
  "quickReview": {
    "overallRating": 5,
    "comments": "Excellent brew!"
  }
}
```

**Response:**
```json
{
  "message": "Review added successfully",
  "review": {
    "id": 2,
    "reviewId": "8c6e2146-6ad2-4f2a-a9f5-f7ad8ebf2a06",
    "apiBrewUuid": "7dfb14c4-d288-4b1e-ae69-ec2d733aa434",
    "brewUuid": "550e8400-e29b-41d4-a716-446655440001",
    "reviewerName": "Public Reviewer",
    "isAnonymous": false,
    "reviewDate": "2024-04-15T14:30:00Z",
    "reviewType": "quick",
    "quickReview": {
      "overallRating": 5,
      "comments": "Excellent brew!"
    },
    "createdAt": "2024-04-15T14:30:00Z",
    "updatedAt": "2024-04-15T14:30:00Z"
  }
}
```

### Fetching Reviews

You can fetch reviews using either the `api_brew_uuid` or the `brew_uuid`:

- By API UUID: `GET /api/reviews/api-brew/{apiBrewUuid}`
- By Companion App UUID: `GET /api/reviews/brew/{brewUuid}`

Both endpoints will return the reviews with both UUIDs.

## Migration Notes

1. The `api_brew_uuid` field is now the primary reference for brews in the API database.
2. The `brew_uuid` field is used as a reference for the companion app.
3. Reviews now reference brews using the `api_brew_uuid` field.
4. For backward compatibility, the API still supports fetching brews and reviews using the `brew_uuid` field.
