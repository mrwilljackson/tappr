# UUID Migration Guide

## Overview

The TAPPR API has been updated to use a dual UUID system for brews (beers). This guide explains the changes and how to update your code to work with the new system.

## Changes

### Before

Previously, the TAPPR API used a single UUID field for brews:

- `brewUuid`: A UUID that served as both the identifier for the brew in the API and the reference for the companion app.

### After

Now, the TAPPR API uses two UUID fields for brews:

1. `api_brew_uuid`: A UUID generated by the API that serves as the unique immutable key for the record in the database.
2. `brew_uuid`: A UUID provided by the companion app that serves as a reference for the app.

## Database Changes

1. The `beers` table has been renamed to `brews`.
2. A new `api_brew_uuid` column has been added to the `brews` table.
3. The `reviews` table now references brews using the `api_brew_uuid` field.

## API Changes

### Creating a New Brew

When creating a new brew, you can provide a `brewUuid` from the companion app. The API will generate a new `api_brew_uuid` for the brew and return both UUIDs in the response.

**Before:**
```json
{
  "name": "New Beer",
  "style": "IPA",
  "abv": 5.5,
  "ibu": 40,
  "description": "Description of the beer",
  "brewDate": "2024-04-01",
  "kegLevel": 100,
  "brewUuid": "550e8400-e29b-41d4-a716-446655440001"
}
```

**After:**
```json
{
  "name": "New Brew",
  "style": "IPA",
  "abv": 5.5,
  "ibu": 40.5,
  "description": "Description of the brew",
  "brewDate": "2024-04-01",
  "kegLevel": 100,
  "brewUuid": "550e8400-e29b-41d4-a716-446655440001"
}
```

**Response (After):**
```json
{
  "message": "Brew added successfully",
  "brew": {
    "id": 4,
    "name": "New Brew",
    "style": "IPA",
    "abv": 5.5,
    "ibu": 40.5,
    "description": "Description of the brew",
    "brewDate": "2024-04-01",
    "kegLevel": 100,
    "brewUuid": "550e8400-e29b-41d4-a716-446655440001",
    "apiBrewUuid": "7dfb14c4-d288-4b1e-ae69-ec2d733aa434",
    "createdAt": "2024-04-15T14:30:00Z",
    "updatedAt": "2024-04-15T14:30:00Z"
  }
}
```

### Fetching a Brew

You can now fetch a brew using either the `api_brew_uuid` or the `brew_uuid`:

- By API UUID: `GET /api/beers/api/{apiBrewUuid}`
- By Companion App UUID: `GET /api/beers/public/{brewUuid}` (unchanged)

Both endpoints will return the brew with both UUIDs.

### Creating a Review

When creating a review, you must now provide the `apiBrewUuid` of the brew being reviewed:

**Before:**
```json
{
  "brewUuid": "550e8400-e29b-41d4-a716-446655440001",
  "reviewerName": "John Doe",
  "reviewType": "quick",
  "quickReview": {
    "overallRating": 4,
    "comments": "Great beer!"
  }
}
```

**After:**
```json
{
  "apiBrewUuid": "7dfb14c4-d288-4b1e-ae69-ec2d733aa434",
  "brewUuid": "550e8400-e29b-41d4-a716-446655440001",
  "reviewerName": "John Doe",
  "reviewType": "quick",
  "quickReview": {
    "overallRating": 4,
    "comments": "Great brew!"
  }
}
```

### Public Review Submission

For public review submissions, you can still provide just the `brewUuid` and the API will look up the corresponding `apiBrewUuid`:

**Before and After (unchanged):**
```json
{
  "brewUuid": "550e8400-e29b-41d4-a716-446655440001",
  "reviewerName": "Public Reviewer",
  "reviewType": "quick",
  "quickReview": {
    "overallRating": 5,
    "comments": "Excellent brew!"
  }
}
```

### Fetching Reviews

You can now fetch reviews using either the `api_brew_uuid` or the `brew_uuid`:

- By API UUID: `GET /api/reviews/api-brew/{apiBrewUuid}` (new)
- By Companion App UUID: `GET /api/reviews/brew/{brewUuid}` (unchanged)

Both endpoints will return the reviews with both UUIDs.

## Migration Steps

1. **Update API Calls**:
   - When creating a new brew, store both the `brewUuid` and `apiBrewUuid` returned in the response.
   - When creating a review, use the `apiBrewUuid` as the primary reference to the brew.
   - Update your code to handle both UUIDs in the responses.

2. **Update Database Queries**:
   - If you're directly querying the database, update your queries to use the `brews` table instead of `beers`.
   - Use the `api_brew_uuid` field as the primary reference for brews in the database.

3. **Update Client Code**:
   - Update your client code to store and use the `apiBrewUuid` for future queries.
   - For backward compatibility, you can continue to use the `brewUuid` for public endpoints.

## Backward Compatibility

For backward compatibility, the API still supports:

- Fetching brews using the companion app UUID: `GET /api/beers/public/{brewUuid}`
- Fetching reviews using the companion app UUID: `GET /api/reviews/brew/{brewUuid}`
- Submitting public reviews using only the companion app UUID: `POST /api/reviews/public/add`

## Benefits of the New System

1. **Clear Separation of Concerns**:
   - `api_brew_uuid`: Internal, immutable database identifier controlled by the API
   - `brew_uuid`: External reference ID used by the companion app

2. **Improved Data Sovereignty**:
   - The API generates and controls its own primary identifiers
   - Not dependent on external systems to provide valid, unique identifiers

3. **Better Security**:
   - Reduces the risk of ID conflicts or manipulation from external sources
   - Provides a layer of abstraction between internal database IDs and what's exposed externally

4. **Enhanced Flexibility**:
   - The companion app can change its UUID scheme without affecting database integrity
   - You can migrate or change your database without breaking external references

5. **Future-Proofing**:
   - Supports scenarios where multiple external systems might reference the same brew with different IDs
   - Allows for potential future features like brew merging or deduplication
